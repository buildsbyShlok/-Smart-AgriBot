#include <WiFi.h>
#include <HTTPClient.h>
#include "DHT.h"
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// ------------------------
// USER CONFIG
// ------------------------
const char* WIFI_SSID = "S24";
const char* WIFI_PASS = "12121212";

// Firebase REST API info
String FIREBASE_HOST = "https://smartfarmbot-523a0-default-rtdb.asia-southeast1.firebasedatabase.app";
String FIREBASE_SECRET = "VgKGhGeiiWwosu6i9ZY96XtognaTMpEpKFBEIIZx";  // keep secure

// ------------------------
// SENSOR PINS
// ------------------------
#define PIN_SOIL_CAP 34
#define PIN_SOIL_FORK 32
#define PIN_LDR 35
#define PIN_FLOAT 25
#define PIN_DHT 23  // YOU SAID YOU USE GPIO23

#define DHTTYPE DHT11
DHT dht(PIN_DHT, DHTTYPE);

// ------------------------
// SENSOR CALIBRATION (UPDATE AFTER TESTING)
// ------------------------
int soilCapDry = 3800;    // ADC in air
int soilCapWet = 1200;    // ADC in water

int soilForkDry = 3700;
int soilForkWet = 900;

// ------------------------
// LCD I2C (change if your address different)
// ------------------------
uint8_t lcdAddr = 0x27; // common: 0x27 or 0x3F â€” update if scanner shows different
LiquidCrystal_I2C lcd(lcdAddr, 16, 2);

// ------------------------
// FUNCTION: AVERAGE ADC
// ------------------------
long readAveragedADC(int pin, int samples = 16) {
  long sum = 0;
  for (int i = 0; i < samples; i++) {
    sum += analogRead(pin);
    delay(5);
  }
  return sum / samples;
}

float mapToPercent(long raw, int dry, int wet) {
  // map expects integers; clamp raw into range first
  if(raw > dry) raw = dry;
  if(raw < wet) raw = wet;
  // map(raw, dry, wet, 0, 100) but dry > wet typically
  long mapped = map(raw, dry, wet, 0, 100);
  if (mapped < 0) mapped = 0;
  if (mapped > 100) mapped = 100;
  return (float)mapped;
}

// ------------------------
// SEND DATA TO FIREBASE
// ------------------------
void sendToFirebase(String path, String jsonPayload) {
  HTTPClient http;
  String url = FIREBASE_HOST + path + "?auth=" + FIREBASE_SECRET;
  http.begin(url);
  http.addHeader("Content-Type", "application/json");
  int httpResponseCode = http.PUT(jsonPayload);
  Serial.print("Firebase response: ");
  Serial.println(httpResponseCode);
  http.end();
}

// ------------------------
// SETUP
// ------------------------
void setup() {
  Serial.begin(115200);
  delay(1000);

  Serial.println("Starting Smart Farm Bot System...");

  // start I2C explicitly (SDA=21, SCL=22). If your wiring uses different pins, change here.
  Wire.begin(21, 22);

  // initialize LCD
  lcd.init();           // initialize the lcd
  lcd.backlight();      // turn on backlight
  lcd.clear();
  lcd.setCursor(0,0);
  lcd.print("SmartFarm Booting");
  lcd.setCursor(0,1);
  lcd.print("Connecting WiFi");

  dht.begin();

  // WiFi connect
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  Serial.print("Connecting to WiFi");
  int wifiTry = 0;
  while (WiFi.status() != WL_CONNECTED && wifiTry < 40) { // ~20s timeout
    delay(500);
    Serial.print(".");
    wifiTry++;
  }
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi Connected!");
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("WiFi connected");
    lcd.setCursor(0,1);
    lcd.print(WIFI_SSID);
  } else {
    Serial.println("\nWiFi FAILED");
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.print("WiFi FAILED");
    lcd.setCursor(0,1);
    lcd.print("Check creds");
  }
  delay(1000);
}

// ------------------------
// MAIN LOOP
// ------------------------
void loop() {

  // ---- READ SENSORS ----
  long rawCap = readAveragedADC(PIN_SOIL_CAP);
  long rawFork = readAveragedADC(PIN_SOIL_FORK);
  long rawLDR = readAveragedADC(PIN_LDR);

  float capPct = mapToPercent(rawCap, soilCapDry, soilCapWet);
  float forkPct = mapToPercent(rawFork, soilForkDry, soilForkWet);

  float temp = dht.readTemperature();
  float hum = dht.readHumidity();
  int tankState = digitalRead(PIN_FLOAT); // HIGH or LOW

  long timestamp = millis();

  // Debug Print
  Serial.println("\n----- Sensor Data -----");
  Serial.printf("Cap Soil: %ld (%0.1f%%)\n", rawCap, capPct);
  Serial.printf("Fork Soil: %ld (%0.1f%%)\n", rawFork, forkPct);
  Serial.printf("LDR: %ld\n", rawLDR);
  Serial.printf("Temperature: %.1fC\n", temp);
  Serial.printf("Humidity: %.1f%%\n", hum);
  Serial.printf("Tank Level: %d\n", tankState);

  // Update LCD: show two lines rotating every loop
  lcd.clear();
  // line 1: soil average and tank
  float soilAvg = NAN;
  if(!isnan(capPct) && !isnan(forkPct)) soilAvg = (capPct + forkPct) / 2.0;
  else if(!isnan(capPct)) soilAvg = capPct;
  else if(!isnan(forkPct)) soilAvg = forkPct;

  char line1[17];
  if(!isnan(soilAvg)){
    snprintf(line1, sizeof(line1), "Soil: %3.0f%% Tank:%d", soilAvg, tankState);
  } else {
    snprintf(line1, sizeof(line1), "Soil: --%% Tank:%d", tankState);
  }
  lcd.setCursor(0,0);
  lcd.print(line1);

  // line 2: temp & hum or LDR
  char line2[17];
  if(!isnan(temp) && !isnan(hum)){
    snprintf(line2, sizeof(line2), "T:%4.1fC H:%3.0f%%", temp, hum);
  } else {
    snprintf(line2, sizeof(line2), "LDR:%ld", rawLDR);
  }
  lcd.setCursor(0,1);
  lcd.print(line2);

  // --------------- REALTIME DATA JSON ----------------
  String realtimeJson = "{";
  realtimeJson += "\"soilCapacitive\": {\"value\": " + String(capPct) + ", \"timestamp\": " + String(timestamp) + "},";
  realtimeJson += "\"soilFork\": {\"value\": " + String(forkPct) + ", \"timestamp\": " + String(timestamp) + "},";
  realtimeJson += "\"ldr\": {\"value\": " + String(rawLDR) + ", \"timestamp\": " + String(timestamp) + "},";
  realtimeJson += "\"dht\": {\"temperature\": " + String(temp) + ", \"humidity\": " + String(hum) + ", \"timestamp\": " + String(timestamp) + "},";
  realtimeJson += "\"tank\": {\"level\": " + String(tankState) + ", \"timestamp\": " + String(timestamp) + "}";
  realtimeJson += "}";

  sendToFirebase("/smartFarm/sensors.json", realtimeJson);

  // --------------- HISTORY LOGS ----------------
  String hist1 = "{ \"" + String(timestamp) + "\": " + String(capPct) + " }";
  sendToFirebase("/smartFarm/history/soilMoisture.json", hist1);

  String hist2 = "{ \"" + String(timestamp) + "\": " + String(temp) + " }";
  sendToFirebase("/smartFarm/history/soilTemperature.json", hist2);

  String hist3 = "{ \"" + String(timestamp) + "\": " + String(rawLDR) + " }";
  sendToFirebase("/smartFarm/history/sunlight.json", hist3);

  delay(5000); // 5 seconds
}
