<div class="card">
  <h2>Sunlight Analysis</h2>
  <p class="sub">Daily sunlight hours & intensity graph</p>
  <canvas id="sunlight-chart" style="height:220px"></canvas>
  <div id="sunlight-insights" style="margin-top:8px"></div>
</div>

<script>
function init_sunlight(){
  const ctx = document.getElementById('sunlight-chart').getContext('2d');
  window.sunlightChart = new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'LDR',data:[],borderColor:'#f4a261',tension:0.3}]},options:{responsive:true}});

  function update(v){
    const ldr = v.ldr?.value ?? null;
    if(ldr!=null){
      pushChartPoint(window.sunlightChart, ldr);
      // insights (simple)
      const recent = window.sunlightChart.data.datasets[0].data.slice(-30);
      const avg = recent.length? (recent.reduce((a,b)=>a+b,0)/recent.length) : null;
      document.getElementById('sunlight-insights').textContent = avg ? ('Recent average LDR: ' + Math.round(avg)) : '';
    }
  }

  window.addEventListener('sf:realtime', (e)=> update(e.detail || {}));
  if(window.globalState && window.globalState.latest) update(window.globalState.latest);

  function pushChartPoint(chart, val){
    chart.data.labels.push('');
    chart.data.datasets[0].data.push(Number(val));
    if(chart.data.labels.length > 80){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
    chart.update();
  }
}
</script>
